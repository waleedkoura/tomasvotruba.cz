<!DOCTYPE html>
<html lang="en">
    <head>
    <title>How to change PHP code with Abstract Syntax Tree | Tomas Votruba</title>
    <meta charset="utf-8">
    <meta name="robots" content="index, follow">

        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">

    
    <link rel="alternate" type="application/rss+xml" title="Tomas Votruba Blog RSS" href="/rss.xml">

        <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.2.0/css/solid.css" integrity="sha384-wnAC7ln+XN0UKdcPvJvtqIH3jOjs9pnKnq9qX68ImXvOGz2JuFoEiCjT8jyZQX2z" crossorigin="anonymous">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.2.0/css/brands.css" integrity="sha384-nT8r1Kzllf71iZl81CdFzObMsaLOhqBU1JD2+XoAALbdtWaXDOlWOZTR4v1ktjPE" crossorigin="anonymous">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.2.0/css/fontawesome.css" integrity="sha384-HbmWTHay9psM8qyzEKPc8odH4DsOuzdejtnr+OFtDmOcIVnhgReQ4GZBH7uwcjf6" crossorigin="anonymous">

        <link href="/assets/bootstrap/bootstrap.min.css?v=460650243" rel="stylesheet" type="text/css" />

    <link href="/assets/prism/prism.css?v=179185525" rel="stylesheet" type="text/css" />

        <link href="/assets/css/style.css?v=1504275534" rel="stylesheet" type="text/css" />

    <link href="/assets/gifplayer/gifplayer.css" rel="stylesheet" type="text/css" />

        <link href="/assets/css/checklist.css?v=100448409" rel="stylesheet" type="text/css" />

    <script src="/assets/js/jquery-3.3.1.slim.min.js"></script>
    <script src="/assets/gifplayer/jquery.gifplayer.js"></script>
    <script src="/assets/js/checklist.js" async defer></script>
</head>
    <body>
        <!-- post_id: 63 -->

        <div class="hidden-sm-down">
    <nav class="navbar">
        <div class="container-fluid">
            <ul>
                <li id="logo">
                    <img src="https://avatars1.githubusercontent.com/u/924196?s=60&v=4" class="avatar">
                    Tomas Votruba
                </li>
                <li class="active">
                    <a href="/">Blog</a>
                </li>
                <li class="">
                    <a href="/clusters/">Clusters</a>
                </li>
                <li class="">
                    <a href="/mission/">Mission</a>
                </li>
                <li class="">
                    <a href="/talks/">Talks</a>
                </li>
                <li class="">
                    <a href="/contact/">Contact</a>
                </li>
                <li id="top-menu-search">
                    <form method="get" action="https://www.google.com/search" itemprop="potentialAction" itemscope="" itemtype="http://schema.org/SearchAction">
                        <meta itemprop="target" content="https://www.google.com/search?q={q}"/>
                        <input name="sitesearch" value="tomasvotruba.cz" type="hidden"/>
                        <input itemprop="query-input" type="text" id="search-query" class="form-control" required="required" name="q" placeholder="Search..." autocomplete="off"/>
                    </form>
                </li>
            </ul>
        </div>
    </nav>
</div>

<div class="hidden-md-up">
    <nav class="navbar" id="mobile-menu">
        <div class="container">
            <a href="/" class="col-3 col-sm-3 active">
                <em class="fas fa-book"></em>
                <br>
                PHP Blog
            </a>
            <a href="/clusters/" class="col-3 col-sm-3 ">
                <em class="fas fa-share-alt"></em>
                <br>
                Clusters
            </a>
            <a href="/mission/" class="col-3 col-sm-3 ">
                <em class="fas fa-heartbeat"></em>
                <br>
                Mission
            </a>
            <a href="/contact/" class="col-3 col-sm-3 ">
                <em class="fas fa-phone"></em>
                <br>
                Contact
            </a>
        </div>
    </nav>

    <div class="hidden-md-up text-center row" id="top-menu-search-mobile">
        <!-- inspired and taken from: https://github.com/yegor256/blog/blob/master/_layouts/default.html -->
        <form method="get" action="https://www.google.com/search" itemprop="potentialAction" itemscope="" itemtype="http://schema.org/SearchAction" class="col-md-12">
            <meta itemprop="target" content="https://www.google.com/search?q={q}"/>
            <input name="sitesearch" value="tomasvotruba.cz" type="hidden"/>
            <input itemprop="query-input" type="text" id="search-query" class="form-control" required="required" name="q" placeholder="Search with Google..." autocomplete="off"/>
        </form>
    </div>
</div>

        <div class="mainContent">
            <div class="container-fluid" id="post">
                <h1 id="how-to-change-php-code-with-abstract-syntax-tree"><a href="#how-to-change-php-code-with-abstract-syntax-tree">How to change PHP code with Abstract Syntax Tree</a></h1>

                <ul class="list-inline post-metadata">
    <li class="list-inline-item mr-3">
        <em class="fas fa-clock fa-fw"></em>
        <strong>4 min</strong>
    </li>

    <li class="list-inline-item mr-3">
        <em class="fas fa-calendar fa-fw"></em>
        <time datetime="2017-11-Mon">Mon, Nov 6, 2017</time>
    </li>

            <li class="list-inline-item mr-3">
            <em class="fas fa-fw fa-comments"></em>
            <a href="https://www.tomasvotruba.cz/blog/2017/11/06/how-to-change-php-code-with-abstract-syntax-tree/#disqus_thread">X</a> comments
        </li>
    
            <li class="list-inline-item">
            <em class="fas fa-fw fa-edit"></em>
            <a href="https://github.com/TomasVotruba/tomasvotruba.cz/edit/master/source/_posts/2017/2017-11-06-how-to-change-php-code-with-abstract-syntax-tree.md">Typo? Fix me, please</a>
        </li>
    
            <li class="list-inline-item pull-right">
                        <a href="https://github.com/TomasVotruba/tomasvotruba.cz/tree/master/tests/Posts/Year2017/Ast" class="badge badge-success">
                <em class="fas fa-fw fa-thumbs-up"></em> Tested
            </a>
        </li>
    </ul>

                
                
                <div class="card card-bigger">
                    <div class="card-body">
                        Today we can do amazing things with PHP. Thanks to AST and <a href="https://github.com/nikic/PHP-Parser">nikic/php-parser</a> we can create very <strong>narrow artificial intelligence, which can work for us</strong>.
<br><br>
Let's create first its synapse!
                    </div>
                </div>

                
                <p>We need to make clear what are we talking about right at the beginning. When we say &quot;PHP AST&quot;, you can talk about 2 things:</p>
<h3 id="1-php-ast"><a href="#1-php-ast">1. php-ast</a></h3>
<p>This is native extension which exports the AST internally used by PHP 7.0+. It allows <strong>read-only</strong> and is very fast, since it's native C extension. Internal AST was added to PHP 7.0 by skill-full Nikita Popov in <a href="https://wiki.php.net/rfc/abstract_syntax_tree">this RFC</a>. You can find it on GitHub under <a href="https://github.com/nikic/php-ast">nikic/php-ast</a>.</p>
<h3 id="2-php-ast"><a href="#2-php-ast">2. PHP AST</a></h3>
<p>This is AST of PHP in Object PHP. It will take your PHP code, turn into PHP object with autocomplete in IDE and <strong>allows you to modify code</strong>. You can find it on GitHub under <a href="https://github.com/nikic/PHP-Parser/"><code>nikic/PHP-Parser</code></a>.</p>
<p>Nikita explains <a href="https://github.com/nikic/php-ast#differences-to-php-parser">differences between those 2 in more detailed technical way</a>. Personally I love <a href="https://github.com/nikic/PHP-Parser/blob/master/doc/0_Introduction.markdown#what-is-this-for">this human reason</a> the most:</p>
<p><br></p>
<blockquote class="blockquote">
    "Why would I want to have a PHP parser written in PHP? Well, PHP might not be a language especially suited for fast parsing, but processing the AST is much easier in PHP than it would be in other, faster languages like C. Furthermore the people most probably wanting to do programmatic PHP code analysis are incidentally PHP developers, not C developers."
    <footer class="blockquote-footer text-right">Nikita Popov</footer></blockquote>
<p><br></p>
<p>Which one would you pick? If you're <strong>lazy like me and hate reading code and writing code</strong> over and over again, the 2nd one.</p>
<h2 id="what-work-can-code-nikic-php-parser-code-do-for-us"><a href="#what-work-can-code-nikic-php-parser-code-do-for-us">What work can <code>nikic/PHP-Parser</code> do for us?</a></h2>
<p>Saying that, <strong>we skip the read-feature</strong> of this package - it's used by <a href="https://github.com/phpstan/phpstan">PHPStan</a> or <a href="https://github.com/Roave/BetterReflection">BetterReflection</a> - and <strong>move right to the writing-feature</strong>. Btw, back in 2012, even <a href="https://github.com/nikic/PHP-Parser/issues/41">Fabien wanted to use it in PHP CS Fixer</a>, but it wasn't ready yet.</p>
<h3 id="when-we-say-em-modify-em-and-em-ast-em-together-what-can-you-brainstorm"><a href="#when-we-say-em-modify-em-and-em-ast-em-together-what-can-you-brainstorm">When we say <em>modify</em> and <em>AST</em> together, what can you brainstorm?</a></h3>
<ul>
<li>change method name</li>
<li>change class name</li>
<li>rename property</li>
<li>change property to method call</li>
<li>move method from one class to another</li>
<li>split class to multiple ones</li>
<li>refactor <code>$this-&gt;get('name')</code> to constructor injection in Symfony App</li>
<li>upgrade App from Symfony 3.0 to 4.0</li>
<li>refactor Laravel App to Symfony App</li>
<li>...</li>
</ul>
<p>It can do many things for you, depends on how much work you put in it. Today we will try to <strong>change method name</strong>.</p>
<h2 id="4-steps-to-changing-a-name"><a href="#4-steps-to-changing-a-name">4 Steps to Changing a name</a></h2>
<h3 id="1-parse-code-to-nodes"><a href="#1-parse-code-to-nodes">1. Parse code to Nodes</a></h3>
<pre><code class="language-bash">composer require nikic/php-parser</code></pre>
<p>Create parser and parse the file:</p>
<pre><code class="language-php">use PhpParser\Parser;
use PhpParser\ParserFactory;

$parser = (new ParserFactory)-&gt;create(ParserFactory::PREFER_PHP7); # or PREFER_PHP5, if your code is older
$nodes = $parser-&gt;parse(file_get_contents(__DIR__ . '/SomeClass.php'));</code></pre>
<h3 id="2-find-method-node"><a href="#2-find-method-node">2. Find Method Node</a></h3>
<p>The best way to work with Nodes is to <strong>traverse them with <a href="https://github.com/nikic/PHP-Parser/blob/master/lib/PhpParser/NodeTraverser.php"><code>PhpParser\NodeTraverser</code></a></strong>:</p>
<pre><code class="language-php">$nodeTraverser = new PhpParser\NodeTraverser;
$traversedNodes = $nodeTraverser-&gt;traverse($nodes);</code></pre>
<p>Now we traversed all nodes, but nothing actually happened. Do you think we forgot to invite somebody in?</p>
<p>Yes, <strong>we need <a href="https://github.com/nikic/PHP-Parser/blob/master/lib/PhpParser/NodeVisitor.php"><code>PhpParser\NodeVisitor</code></a></strong> - an interface with 4 methods. We can either implement all 4 of them, or use <a href="https://github.com/nikic/PHP-Parser/blob/master/lib/PhpParser/NodeVisitorAbstract.php"><code>PhpParser\NodeVisitorAbstract</code></a> to save some work:</p>
<pre><code class="language-php">use PhpParser\NodeVisitorAbstract;

final class ChangeMethodNameNodeVisitor extends NodeVisitorAbstract
{
}</code></pre>
<p>We need to find a <code>ClassMethod</code> node. I know that, because I use this package often, <strong>but you can <a href="https://github.com/nikic/PHP-Parser/tree/master/lib/PhpParser/Node">find all nodes here</a></strong>. To do that, we'll use <code>enterNode()</code> method:</p>
<pre><code class="language-php">use PhpParser\Node;
use PhpParser\NodeVisitorAbstract;
use PhpParser\Node\Stmt\ClassMethod;

final class ChangeMethodNameNodeVisitor extends NodeVisitorAbstract
{
    public function enterNode(Node $node)
    {
        if (! $node instanceof ClassMethod) {
            return false;
        }

        // so we got it, what now?
    }
}</code></pre>
<h3 id="3-change-method-name"><a href="#3-change-method-name">3. Change Method Name</a></h3>
<p>No we find it's name and change it!</p>
<pre><code class="language-php">use PhpParser\Node;
use PhpParser\Node\Name;
use PhpParser\Node\Stmt\ClassMethod;
use PhpParser\NodeVisitorAbstract;

final class ChangeMethodNameNodeVisitor extends NodeVisitorAbstract
{
    public function enterNode(Node $node)
    {
        if (! $node instanceof ClassMethod) {
            return false;
        }

        $node-&gt;name = new Name('newName');

        // return node to tell parser to modify it
        return $node;
    }
}</code></pre>
<p>To work with <strong>class names, interface names, method names</strong> etc., we need to <strong>use <code>PhpParser\Node\Name</code></strong>.</p>
<p>Oh, I almost forgot, we need to actually <strong>invite visitor to the <code>NodeTraverser</code></strong> like this:</p>
<pre><code class="language-php">$nodeTraverser = new PhpParser\NodeTraverser;
$traversedNodes-&gt;addVisitor(new ChangeMethodNameNodeVisitor);
$traversedNodes = $nodeTraverser-&gt;traverse($nodes);</code></pre>
<h3 id="4-save-to-file"><a href="#4-save-to-file">4. Save to File</a></h3>
<p>Last step is saving the file (<a href="https://github.com/nikic/PHP-Parser/blob/master/doc/component/Pretty_printing.markdown">see docs</a>). We have 2 options here:</p>
<p><br></p>
<p><strong>A. Dumb Saving</strong></p>
<pre><code class="language-php">$prettyPrinter = new PhpParser\PrettyPrinter\Standard;
$newCode = $prettyPrinter-&gt;prettyPrintFile($traversedNodes);

file_put_contents(__DIR__ . '/SomeClass.php', $newCode);</code></pre>
<p>But this will actually <strong>removes spaces and comments</strong>. How to make it right?</p>
<p><br></p>
<p><strong>B. Format-Preserving Printer</strong></p>
<p>It requires more steps, but you will have output much more under control.</p>
<p>Without our code, it would look like this:</p>
<pre><code class="language-php">use PhpParser\Lexer\Emulative;
use PhpParser\NodeTraverser;
use PhpParser\NodeVisitor;
use PhpParser\NodeVisitor\CloningVisitor;
use PhpParser\Parser\Php7;
use PhpParser\PrettyPrinter\Standard;

$lexer = new Emulative([
    'usedAttributes' =&gt; [
        'comments',
        'startLine', 'endLine',
        'startTokenPos', 'endTokenPos',
    ],
]);

$parser = new Php7($lexer);
$traverser = new NodeTraverser;
$traverser-&gt;addVisitor(new CloningVisitor);

$oldStmts = $parser-&gt;parse($code);
$oldTokens = $lexer-&gt;getTokens();

$newStmts = $traverser-&gt;traverse($oldStmts);

// our code start

$nodeTraverser = new NodeTraverser;
$nodeTraverser-&gt;addVisitor($nodeVisitor);

$newStmts = $traversedNodes = $nodeTraverser-&gt;traverse($newStmts);

// our code end

$newCode = (new Standard)-&gt;printFormatPreserving($newStmts, $oldStmts, $oldTokens);</code></pre>
<p>Congrats, now you've successfully renamed method to <code>newName</code>!</p>
<h2 id="advanced-changes-with-rector"><a href="#advanced-changes-with-rector">Advanced Changes? With Rector!</a></h2>
<p>Do you want to see more advanced operations, like those we <a href="#when-we-say-em-modify-em-and-em-ast-em-together-what-can-you-brainstorm">brainstormed in the beginning</a>? Look at package I'm working on which should <strong>automate application upgrades</strong> - <strong><a href="https://github.com/RectorPHP/Rector">RectorPHP</a></strong>.</p>
<p><br></p>
<h3 id="this-post-is-tested"><a href="#this-post-is-tested">This post is Tested</a></h3>
<p>This is the first <a href="https://pehapkari.cz/blog/2017/01/12/why-articles-with-code-examples-should-be-CI-tested/">tested post</a> I've added to my blog.
It means <strong>it will be updated as new versions of code used here will appear</strong> → <em>LTS post</em> that will work with newer <code>nikic/php-parser</code> versions.</p>
<p>Do you want to see those tests? Just click <em>Tested</em> badge in the top.</p>
<p><br></p>
<p>Let me know in the comments, what would you like to read about AST and its Traversing and Modification. I might inspire by your ideas.</p>
<p>Happy traversing!</p>

                <br>

                                    <div class="mt-1 mb-5 card">
                        <div class="card-header text-center">
                            <h3 class="text-center mt-2">
                                <em class="fas fa-check text-success"></em>
                                &nbsp;
                                Travis Knowns the Code Works
                            </h3>
                        </div>

                        <div class="card-body">
                            
                            <p>
                                The code used in this post is tested daily with Travis CI. You can <a href="https://github.com/TomasVotruba/tomasvotruba.cz/tree/master/tests/Posts/Year2017/Ast">see tests on Github</a>.
                            </p>

                            <p>
                                Thanks to tests this post:
                                <ul>
                                    <li>always run against the most recent dependencies</li>
                                <li><strong>gets updates and stays relevant for many years</strong> even when new <a href="https://semver.org/#spec-item-8">major version</a> of PHP or Symfony is released</li>
                                </ul>
                            </p>
                        </div>
                    </div>
                
                <div class="card mb-5">
                    <div class="card-body text-center">
                        <a href="https://github.com/TomasVotruba/tomasvotruba.cz/edit/master/source/_posts/2017/2017-11-06-how-to-change-php-code-with-abstract-syntax-tree.md" class="btn btn-info btn-sm">
                            <em class="fas fa-fw fa-edit"></em>
                            Typo? Fix it, please
                        </a>
                        &nbsp;and join <a href="/thank-you">56 people</a> who build this website
                    </div>
                </div>

                <a name="comments"></a>

                <div id="disqus_thread"></div>

<script type="text/javascript">
    /**
     *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
     *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
     */
    (function() {  // DON'T EDIT BELOW THIS LINE
        var d = document, s = d.createElement('script');

        s.src = '//' + 'itsworthsharing' + '.disqus.com/embed.js';

        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
            </div>

            <script id="dsq-count-scr" src="https://itsworthsharing.disqus.com/count.js" async defer></script>
        </div>

        <script>
    ga=function(){ ga.q.push(arguments) };
    ga.q=[];
    ga.l=+new Date;
    ga('create', 'UA-46082345-1', 'auto');
    ga('send','pageview');
</script>
<script src="https://www.google-analytics.com/analytics.js" async defer></script>

<script src="/assets/prism/prism.js"></script>

<script>
    $('.gifplayer').gifplayer();
</script>

<div class="text-center mt-5" id="footer">
    <div class="row">
        <div class="col-12">
            Join 17 000 PHP developers every month: <a href="/rss.xml">RSS</a>&nbsp;or&nbsp;<a href="https://twitter.com/votrubaT">@votrubaT</a>

            <span class="pl-2 pr-2 hidden-sm-down">•</span>

            <span class="hidden-sm-down">
                Watch my <a href="https://github.com/tomasvotruba">open-source addiction</a>
            </span>
        </div>
    </div>

    <p>
        Build by <a href="/thank-you/">56 people</a>

        <span class="pl-2 pr-2">•</span>

        Runs on <a href="https://www.statie.org/">Statie</a>

        <span class="pl-2 pr-2">•</span>

        <a href="/now/">Now</a>

        <span class="hidden-sm-down">
            <span class="pl-2 pr-2">•</span>
            Hosted on <a href="https://github.com/tomasvotruba/tomasvotruba.cz">GitHub</a>
        </span>
    </p>
</div>
    </body>
</html>

        <meta property="og:type" content="article" />
    <meta property="og:title" content="How to change PHP code with Abstract Syntax Tree" />
    <meta property="og:description" content="Today we can do amazing things with PHP. Thanks to AST and nikic/php-parser we can create very narrow artificial intelligence, which can work for us.

Let&#039;s create first its synapse!" />
    <meta property="og:url" content="https://www.tomasvotruba.cz/blog/2017/11/06/how-to-change-php-code-with-abstract-syntax-tree" />

        <meta name="twitter:card" content="summary" />
    <meta name="twitter:site" content="@votrubaT">
    <meta name="twitter:title" content="How to change PHP code with Abstract Syntax Tree" />
    <meta name="twitter:description" content="Today we can do amazing things with PHP. Thanks to AST and nikic/php-parser we can create very narrow artificial intelligence, which can work for us.

Let&#039;s create first its synapse!" />
