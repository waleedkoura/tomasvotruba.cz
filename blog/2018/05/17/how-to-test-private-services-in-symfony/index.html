<!DOCTYPE html>
<html lang="en">
    <head>
    <title>How to Test Private Services in Symfony | Tomas Votruba</title>
    <meta charset="utf-8">
    <meta name="robots" content="index, follow">

        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">

    
    <link rel="alternate" type="application/rss+xml" title="Tomas Votruba Blog RSS" href="/rss.xml">

        <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.2.0/css/solid.css" integrity="sha384-wnAC7ln+XN0UKdcPvJvtqIH3jOjs9pnKnq9qX68ImXvOGz2JuFoEiCjT8jyZQX2z" crossorigin="anonymous">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.2.0/css/brands.css" integrity="sha384-nT8r1Kzllf71iZl81CdFzObMsaLOhqBU1JD2+XoAALbdtWaXDOlWOZTR4v1ktjPE" crossorigin="anonymous">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.2.0/css/fontawesome.css" integrity="sha384-HbmWTHay9psM8qyzEKPc8odH4DsOuzdejtnr+OFtDmOcIVnhgReQ4GZBH7uwcjf6" crossorigin="anonymous">

        <link href="/assets/bootstrap/bootstrap.min.css?v=1042301115" rel="stylesheet" type="text/css" />

    <link href="/assets/prism/prism.css?v=953093622" rel="stylesheet" type="text/css" />

        <link href="/assets/css/style.css?v=1785160056" rel="stylesheet" type="text/css" />

    <link href="/assets/gifplayer/gifplayer.css" rel="stylesheet" type="text/css" />

        <link href="/assets/css/checklist.css?v=1940826677" rel="stylesheet" type="text/css" />

    <script src="/assets/js/jquery-3.3.1.slim.min.js"></script>
    <script src="/assets/gifplayer/jquery.gifplayer.js"></script>
    <script src="/assets/js/checklist.js" async defer></script>
</head>
    <body>
        <!-- post_id: 106 -->

        <div class="hidden-sm-down">
    <nav class="navbar">
        <div class="container-fluid">
            <ul>
                <li id="logo">
                    <img src="https://avatars1.githubusercontent.com/u/924196?s=60&v=4" class="avatar">
                    Tomas Votruba
                </li>
                <li class="active">
                    <a href="/">Blog</a>
                </li>
                <li class="">
                    <a href="/clusters/">Clusters</a>
                </li>
                <li class="">
                    <a href="/mission/">Mission</a>
                </li>
                <li class="">
                    <a href="/talks/">Talks</a>
                </li>
                <li class="">
                    <a href="/contact/">Contact</a>
                </li>
                <li id="top-menu-search">
                    <form method="get" action="https://www.google.com/search" itemprop="potentialAction" itemscope="" itemtype="http://schema.org/SearchAction">
                        <meta itemprop="target" content="https://www.google.com/search?q={q}"/>
                        <input name="sitesearch" value="tomasvotruba.cz" type="hidden"/>
                        <input itemprop="query-input" type="text" id="search-query" class="form-control" required="required" name="q" placeholder="Search..." autocomplete="off"/>
                    </form>
                </li>
            </ul>
        </div>
    </nav>
</div>

<div class="hidden-md-up">
    <nav class="navbar" id="mobile-menu">
        <div class="container">
            <a href="/" class="col-3 col-sm-3 active">
                <em class="fas fa-book"></em>
                <br>
                PHP Blog
            </a>
            <a href="/clusters/" class="col-3 col-sm-3 ">
                <em class="fas fa-share-alt"></em>
                <br>
                Clusters
            </a>
            <a href="/mission/" class="col-3 col-sm-3 ">
                <em class="fas fa-heartbeat"></em>
                <br>
                Mission
            </a>
            <a href="/contact/" class="col-3 col-sm-3 ">
                <em class="fas fa-phone"></em>
                <br>
                Contact
            </a>
        </div>
    </nav>

    <div class="hidden-md-up text-center row" id="top-menu-search-mobile">
        <!-- inspired and taken from: https://github.com/yegor256/blog/blob/master/_layouts/default.html -->
        <form method="get" action="https://www.google.com/search" itemprop="potentialAction" itemscope="" itemtype="http://schema.org/SearchAction" class="col-md-12">
            <meta itemprop="target" content="https://www.google.com/search?q={q}"/>
            <input name="sitesearch" value="tomasvotruba.cz" type="hidden"/>
            <input itemprop="query-input" type="text" id="search-query" class="form-control" required="required" name="q" placeholder="Search with Google..." autocomplete="off"/>
        </form>
    </div>
</div>

        <div class="mainContent">
            <div class="container-fluid" id="post">
                <h1 id="how-to-test-private-services-in-symfony"><a href="#how-to-test-private-services-in-symfony">How to Test Private Services in Symfony</a></h1>

                <ul class="list-inline post-metadata">
    <li class="list-inline-item mr-3">
        <em class="fas fa-clock fa-fw"></em>
        <strong>5 min</strong>
    </li>

    <li class="list-inline-item mr-3">
        <em class="fas fa-calendar fa-fw"></em>
        <time datetime="2018-05-Thu">Thu, May 17, 2018</time>
    </li>

            <li class="list-inline-item mr-3">
            <em class="fas fa-fw fa-comments"></em>
            <a href="https://www.tomasvotruba.cz/blog/2018/05/17/how-to-test-private-services-in-symfony/#disqus_thread">X</a> comments
        </li>
    
            <li class="list-inline-item">
            <em class="fas fa-fw fa-edit"></em>
            <a href="https://github.com/TomasVotruba/tomasvotruba.cz/edit/master/source/_posts/2018/2018-05-17-how-to-test-private-services-in-symfony.md">Typo? Fix me, please</a>
        </li>
    
    </ul>

                
                
                <div class="card card-bigger">
                    <div class="card-body">
                        2 versions of Symfony are affected by this dissonance between services and tests.
<strong>Do you use Symfony 3.4 or 4.0? Do you want to test your services, but struggle to get them in a clean way?</strong>
<br><br>
Today we look at possible solutions.
                    </div>
                </div>

                
                <p>If you know the problem and look only for a solution, jump right down to <a href="#2-in-symfony-4-1-standalone-or-symfony-3-4-4-0">Symfony 4.1 Standalone or Symfony 3.4/4.0 solution</a>.</p>
<hr />
<p>Since <a href="https://symfony.com/blog/new-in-symfony-3-4-services-are-private-by-default">Symfony 3.4 all services are private by default</a>.
That means you can't get service by <code>$this-&gt;get(App\SomeService::class)</code> or <code>$this-&gt;container-&gt;get(App\SomeService::class)</code> anymore, but <strong>only only via constructor</strong>.</p>
<p>That's ok until you need to test such service:</p>
<pre><code class="language-php">use App\SomeService;
use PHPUnit\Framework\TestCase;

final class SomeServiceTest extends TestCase
{
    public function testSomeMethod()
    {
        $kernel = new AppKernel;
        $kernel-&gt;boot();
        $container = $kernel-&gt;getContainer();

        // this line is important ↓
        $someService = $container-&gt;get(SomeService::class);
        // ...
    }
}</code></pre>
<p>When we run the test:</p>
<pre><code class="language-bash">vendor/bin/phpunit tests</code></pre>
<p>This exception will stop us:</p>
<pre><code class="language-yaml">The "App\SomeService" service or alias has been removed or inlined when the container
was compiled. You should either make it public, or stop using the container directly
and use dependency injection instead.</code></pre>
<p>...<em>make it public</em>...</p>
<p>Ok!</p>
<pre><code class="language-diff"> # app/config/config.yml
 services:
     _defaults:
         autowire: true

     App\:
         resource: ..
+
+    App\SomeService:
+        public: true</code></pre>
<p>And run tests again:</p>
<pre><code class="language-bash">vendor/bin/phpunit tests</code></pre>
<p class="text-success pt-3 pb-3">
    <em class="fas fa-fw fa-lg fa-check"></em> Voilá!
</p>
<h2 id="down-the-smelly-rabbit-hole"><a href="#down-the-smelly-rabbit-hole">Down the Smelly Rabbit Hole</a></h2>
<p>As you can see, we can load dozens of service from <code>App\</code> by 2 lines. But to test 1, we need to add 2 extra lines to config.</p>
<pre><code class="language-diff"> # app/config/config.yml
 services:
     _defaults:
         autowire: true

     App\:
         resource: ..
+
+    # for tests only
+    App\SomeService:
+        public: true
+
+    App\AnotherService:
+        public: true
+
+    App\YetAnotherService:
+        public: true</code></pre>
<p>This is <em>one to many</em> code smell.</p>
<p>Also, we can <strong>extract it to test config</strong> <code>tests/config/config.yml</code>, so it's easier to hide the smell.</p>
<p>Or just <strong>make everything public</strong>, like <a href="https://github.com/Symplify/Symplify/commit/d0457773915fa32df08e7342d5cd0093f97850ff">I did in Symplify 6 months ago</a>:</p>
<pre><code class="language-diff"> services:
     _defaults:
         autowire: true
+        # for tests only
+        public: true

      App\:
          resource: ..</code></pre>
<p>It's fast and easy solution, but...</p>
<p class="text-danger pt-3 pb-3">
    <em class="fas fa-fw fa-lg fa-times"></em> Not a way to go in long-term or bigger projects.
</p>
<p>Don't worry, you're not alone. There are over <a href="https://stackoverflow.com/search?q=symfony+tests+private+services">36 results for &quot;symfony tests private services&quot; on StackOverflow</a> at the time being:</p>
<img src="/assets/images/posts/2018/private-services/popular.png" class="img-thumbnail">
<p>But what other saint options we have?</p>
<h2 id="1-in-symfony-4-1-with-frameworkbundle"><a href="#1-in-symfony-4-1-with-frameworkbundle">1. In Symfony 4.1 with FrameworkBundle</a></h2>
<p>This is now fixed in
<a href="https://symfony.com/blog/new-in-symfony-4-1-simpler-service-testing">Symfony 4.1 with Simpler service testing</a>.</p>
<p>Do you use</p>
<ul>
<li><code>Symfony\Bundle\FrameworkBundle\Test\KernelTestCase</code> or</li>
<li><code>Symfony\Bundle\FrameworkBundle\Test\WebTestCase</code></li>
</ul>
<p>for your tests? <strong>Just upgrade to Symfony 4.1 and you're done.</strong></p>
<h2 id="2-in-symfony-4-1-standalone-or-symfony-3-4-4-0"><a href="#2-in-symfony-4-1-standalone-or-symfony-3-4-4-0">2. In Symfony 4.1 Standalone or Symfony 3.4/4.0</a></h2>
<p>But what if you don't use <code>FrameworkBundle</code>, e.g. you develop <a href="/blog/2017/12/25/composer-local-packages-for-dummies/">standalone packages</a> and you only use Symfony\Console and Symfony\DependencyInjection?</p>
<p>It's reasonable we want to <strong>keep all configs untouched</strong>, no matter if we're in dev or tests.</p>
<pre><code class="language-yaml"># app/config/config.yml
services:
    _defaults:
        autowire: true

    App\:
        resource: ..</code></pre>
<p>And tests as well:</p>
<pre><code class="language-php">use App\SomeService;
use PHPUnit\Framework\TestCase;

final class SomeServiceTest extends TestCase
{
    public functoin testSomeMethod()
    {
        $kernel = new AppKernel;
        $kernel-&gt;boot();
        $container = $kernel-&gt;getContainer();

        $someService = $container-&gt;get(SomeService::class);
        // ...
    }
}</code></pre>
<p>If there would only be one place with a switch, that would make that all code smells go away and let us test. That would be awesome, right? How can we achieve that? Any ideas?</p>
<h3 id="quot-what-about-compiler-pass-quot"><a href="#quot-what-about-compiler-pass-quot">&quot;What about Compiler Pass?&quot;</a></h3>
<p>Exactly, <a href="https://symfony.com/doc/current/service_container/compiler_passes.html">a Compiler Pass</a>! <strong>One of the best features in Symfony - by abilities and by architecture design</strong>. It leads you to write nice, decoupled and reusable code by default. After all, the solution for Symfony 4.1 is done by <a href="https://github.com/symfony/symfony/pull/26499/files#diff-ce4ed09b11d8fa531159e96df52124f3">Compiler Pass, that creates public 'test.service-name' aliases</a>.</p>
<p>You can write your own that covers needs of your own application (much recommended) or if you use PHPUnit, make use of the one in <a href="/blog/2018/04/05/4-ways-to-speedup-your-symfony-development-with-packagebuilder/#2-drop-manual-code-public-true-code-for-every-service-you-test">Symplify\PackageBuilder</a>:</p>
<pre><code class="language-diff"> use Symfony\Component\HttpKernel\Kernel;
+use Symplify\PackageBuilder\DependencyInjection\CompilerPass\PublicForTestsCompilerPass;

 final class AppKernel extends Kernel
 {
     protected function build(ContainerBuilder $containerBuilder): void
     {
         $containerBuilder-&gt;addCompilerPass('...');
+        $containerBuilder-&gt;addCompilerPass(new PublicForTestsCompilerPass());
     }
 }</code></pre>
<p>This removed all <code>public: true</code> code smells from Symplify, just <a href="https://github.com/Symplify/Symplify/pull/680/commits/eddc6d0db92000d4b1eb01c820863838ff37ac92">see this beautiful commit</a>:</p>
<img src="/assets/images/posts/2018/private-services/gone.png" class="img-thumbnail">
<p class="text-success pt-3 pb-3">
    <em class="fas fa-fw fa-lg fa-check"></em> Voilá!
</p>
<h3 id="where-is-the-magic"><a href="#where-is-the-magic">Where is the Magic?</a></h3>
<p>This is all the &quot;magic&quot; in <a href="https://github.com/Symplify/Symplify/blob/7ed7fc08a4c8fed266caed4cc90cf56c35ea72b0/packages/PackageBuilder/src/DependencyInjection/CompilerPass/PublicForTestsCompilerPass.php#L11"><code>PublicForTestsCompilerPass</code></a>:</p>
<pre><code class="language-php">use Symfony\Component\DependencyInjection\Compiler\CompilerPassInterface;
use Symfony\Component\DependencyInjection\ContainerBuilder;

final class PublicForTestsCompilerPass implements CompilerPassInterface
{
    public function process(ContainerBuilder $containerBuilder): void
    {
        if (! $this-&gt;isPHPUnit()) {
            return;
        }

        foreach ($containerBuilder-&gt;getDefinitions() as $definition) {
            $definition-&gt;setPublic(true);
        }

        foreach ($containerBuilder-&gt;getAliases() as $definition) {
            $definition-&gt;setPublic(true);
        }
    }

    private function isPHPUnit(): bool
    {
        // defined by PHPUnit
        return defined('PHPUNIT_COMPOSER_INSTALL') || defined('__PHPUNIT_PHAR__');
    }
}</code></pre>
<p><strong>It makes every services public, when in PHPUnit run</strong>. Pretty clear, huh?</p>
<p>There is also similar package by a friend of mine <a href="http://tnyholm.se/">Tobias Nyholm</a> called <a href="https://github.com/SymfonyTest/symfony-bundle-test">SymfonyTest/symfony-bundle-test</a>. Check at least <a href="https://github.com/SymfonyTest/symfony-bundle-test/blob/master/src/CompilerPass/PublicServicePass.php">the super short CompilerPass</a>.</p>
<h2 id="other-existing-solutions"><a href="#other-existing-solutions">Other Existing Solutions</a></h2>
<p>I don't find them useful myself, but maybe you will.</p>
<ul>
<li><a href="https://github.com/doctrine/DoctrineBundle/blob/1f504e5dc538b8ee151e0943dea5127ceffd1436/Tests/ServiceRepositoryTest.php#L71">add per service manual alias as in <code>doctrine/DoctrineBundle</code> tests</a></li>
<li><a href="https://github.com/jakzal/phpunit-injector">set properties via <code>@inject</code> annotations with <code>jakzal/phpunit-injector</code> package</a></li>
</ul>
<h3 id="diversity-matters"><a href="#diversity-matters">Diversity Matters</a></h3>
<p><strong>Do you have another solution? Just drop a comment, all add it here.</strong></p>
<p>I'm very curious to find all the solutions people make for 1 problem they have common. How these solutions are diverse, but also similar.</p>
<p><br><br></p>
<p>Happy Symfony service testing!</p>

                <br>

                
                <div class="card mb-5">
                    <div class="card-body text-center">
                        <a href="https://github.com/TomasVotruba/tomasvotruba.cz/edit/master/source/_posts/2018/2018-05-17-how-to-test-private-services-in-symfony.md" class="btn btn-info btn-sm">
                            <em class="fas fa-fw fa-edit"></em>
                            Typo? Fix it, please
                        </a>
                        &nbsp;and join <a href="/thank-you">56 people</a> who build this website
                    </div>
                </div>

                <a name="comments"></a>

                <div id="disqus_thread"></div>

<script type="text/javascript">
    /**
     *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
     *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
     */
    (function() {  // DON'T EDIT BELOW THIS LINE
        var d = document, s = d.createElement('script');

        s.src = '//' + 'itsworthsharing' + '.disqus.com/embed.js';

        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
            </div>

            <script id="dsq-count-scr" src="https://itsworthsharing.disqus.com/count.js" async defer></script>
        </div>

        <script>
    ga=function(){ ga.q.push(arguments) };
    ga.q=[];
    ga.l=+new Date;
    ga('create', 'UA-46082345-1', 'auto');
    ga('send','pageview');
</script>
<script src="https://www.google-analytics.com/analytics.js" async defer></script>

<script src="/assets/prism/prism.js"></script>

<script>
    $('.gifplayer').gifplayer();
</script>

<div class="text-center mt-5" id="footer">
    <div class="row">
        <div class="col-12">
            Join 17 000 PHP developers every month: <a href="/rss.xml">RSS</a>&nbsp;or&nbsp;<a href="https://twitter.com/votrubaT">@votrubaT</a>

            <span class="pl-2 pr-2 hidden-sm-down">•</span>

            <span class="hidden-sm-down">
                Watch my <a href="https://github.com/tomasvotruba">open-source addiction</a>
            </span>
        </div>
    </div>

    <p>
        Build by <a href="/thank-you/">56 people</a>

        <span class="pl-2 pr-2">•</span>

        Runs on <a href="https://www.statie.org/">Statie</a>

        <span class="pl-2 pr-2">•</span>

        <a href="/now/">Now</a>

        <span class="hidden-sm-down">
            <span class="pl-2 pr-2">•</span>
            Hosted on <a href="https://github.com/tomasvotruba/tomasvotruba.cz">GitHub</a>
        </span>
    </p>
</div>
    </body>
</html>

        <meta property="og:type" content="article" />
    <meta property="og:title" content="How to Test Private Services in Symfony" />
    <meta property="og:description" content="2 versions of Symfony are affected by this dissonance between services and tests.
Do you use Symfony 3.4 or 4.0? Do you want to test your services, but struggle to get them in a clean way?

Today we look at possible solutions." />
    <meta property="og:url" content="https://www.tomasvotruba.cz/blog/2018/05/17/how-to-test-private-services-in-symfony" />

        <meta name="twitter:card" content="summary" />
    <meta name="twitter:site" content="@votrubaT">
    <meta name="twitter:title" content="How to Test Private Services in Symfony" />
    <meta name="twitter:description" content="2 versions of Symfony are affected by this dissonance between services and tests.
Do you use Symfony 3.4 or 4.0? Do you want to test your services, but struggle to get them in a clean way?

Today we look at possible solutions." />
