<!DOCTYPE html>
<html lang="en">
    <head>
    <title>Will Autowired Arrays Finally Deprecate Tags in Symfony and Nette? | Tomas Votruba</title>
    <meta charset="utf-8">
    <meta name="robots" content="index, follow">

        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">

    
    <link rel="alternate" type="application/rss+xml" title="Tomas Votruba Blog RSS" href="/rss.xml">

        <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.2.0/css/solid.css" integrity="sha384-wnAC7ln+XN0UKdcPvJvtqIH3jOjs9pnKnq9qX68ImXvOGz2JuFoEiCjT8jyZQX2z" crossorigin="anonymous">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.2.0/css/brands.css" integrity="sha384-nT8r1Kzllf71iZl81CdFzObMsaLOhqBU1JD2+XoAALbdtWaXDOlWOZTR4v1ktjPE" crossorigin="anonymous">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.2.0/css/fontawesome.css" integrity="sha384-HbmWTHay9psM8qyzEKPc8odH4DsOuzdejtnr+OFtDmOcIVnhgReQ4GZBH7uwcjf6" crossorigin="anonymous">

        <link href="/assets/bootstrap/bootstrap.min.css?v=1606343931" rel="stylesheet" type="text/css" />

    <link href="/assets/prism/prism.css?v=2059247760" rel="stylesheet" type="text/css" />

        <link href="/assets/css/style.css?v=1052856852" rel="stylesheet" type="text/css" />

    <link href="/assets/gifplayer/gifplayer.css" rel="stylesheet" type="text/css" />

        <link href="/assets/css/checklist.css?v=184275419" rel="stylesheet" type="text/css" />

    <script src="/assets/js/jquery-3.3.1.slim.min.js"></script>
    <script src="/assets/gifplayer/jquery.gifplayer.js"></script>
    <script src="/assets/js/checklist.js" async defer></script>
</head>
    <body>
        <!-- post_id: 158 -->

        <div class="hidden-sm-down">
    <nav class="navbar">
        <div class="container-fluid">
            <ul>
                <li id="logo">
                    <img src="https://avatars1.githubusercontent.com/u/924196?s=60&v=4" class="avatar">
                    Tomas Votruba
                </li>
                <li class="active">
                    <a href="/">Blog</a>
                </li>
                <li class="">
                    <a href="/clusters/">Clusters</a>
                </li>
                <li class="">
                    <a href="/mission/">Mission</a>
                </li>
                <li class="">
                    <a href="/talks/">Talks</a>
                </li>
                <li class="">
                    <a href="/contact/">Contact</a>
                </li>
                <li id="top-menu-search">
                    <form method="get" action="https://www.google.com/search" itemprop="potentialAction" itemscope="" itemtype="http://schema.org/SearchAction">
                        <meta itemprop="target" content="https://www.google.com/search?q={q}"/>
                        <input name="sitesearch" value="tomasvotruba.cz" type="hidden"/>
                        <input itemprop="query-input" type="text" id="search-query" class="form-control" required="required" name="q" placeholder="Search..." autocomplete="off"/>
                    </form>
                </li>
            </ul>
        </div>
    </nav>
</div>

<div class="hidden-md-up">
    <nav class="navbar" id="mobile-menu">
        <div class="container">
            <a href="/" class="col-3 col-sm-3 active">
                <em class="fas fa-book"></em>
                <br>
                PHP Blog
            </a>
            <a href="/clusters/" class="col-3 col-sm-3 ">
                <em class="fas fa-share-alt"></em>
                <br>
                Clusters
            </a>
            <a href="/mission/" class="col-3 col-sm-3 ">
                <em class="fas fa-heartbeat"></em>
                <br>
                Mission
            </a>
            <a href="/contact/" class="col-3 col-sm-3 ">
                <em class="fas fa-phone"></em>
                <br>
                Contact
            </a>
        </div>
    </nav>

    <div class="hidden-md-up text-center row" id="top-menu-search-mobile">
        <!-- inspired and taken from: https://github.com/yegor256/blog/blob/master/_layouts/default.html -->
        <form method="get" action="https://www.google.com/search" itemprop="potentialAction" itemscope="" itemtype="http://schema.org/SearchAction" class="col-md-12">
            <meta itemprop="target" content="https://www.google.com/search?q={q}"/>
            <input name="sitesearch" value="tomasvotruba.cz" type="hidden"/>
            <input itemprop="query-input" type="text" id="search-query" class="form-control" required="required" name="q" placeholder="Search with Google..." autocomplete="off"/>
        </form>
    </div>
</div>

        <div class="mainContent">
            <div class="container-fluid" id="post">
                <h1 id="will-autowired-arrays-finally-deprecate-tags-in-symfony-and-nette"><a href="#will-autowired-arrays-finally-deprecate-tags-in-symfony-and-nette">Will Autowired Arrays Finally Deprecate Tags in Symfony and Nette?</a></h1>

                <ul class="list-inline post-metadata">
    <li class="list-inline-item mr-3">
        <em class="fas fa-clock fa-fw"></em>
        <strong>4 min</strong>
    </li>

    <li class="list-inline-item mr-3">
        <em class="fas fa-calendar fa-fw"></em>
        <time datetime="2018-11-Mon">Mon, Nov 12, 2018</time>
    </li>

            <li class="list-inline-item mr-3">
            <em class="fas fa-fw fa-comments"></em>
            <a href="https://www.tomasvotruba.cz/blog/2018/11/12/will-autowired-arrays-finally-deprecate-tags-in-symfony-and-nette/#disqus_thread">X</a> comments
        </li>
    
            <li class="list-inline-item">
            <em class="fas fa-fw fa-edit"></em>
            <a href="https://github.com/TomasVotruba/tomasvotruba.cz/edit/master/source/_posts/2018/2018-11-12-will-autowired-arrays-finally-deprecate-tags-in-symfony-and-nette.md">Typo? Fix me, please</a>
        </li>
    
    </ul>

                
                
                <div class="card card-bigger">
                    <div class="card-body">
                        To be clear: we talk about those tags that only have a name. No priority, no level, no event name, nothing, <strong>just the name</strong>. If you're not sure why these tags are bad, read <em><a href="/blog/2017/02/12/drop-all-service-tags-in-your-nette-and-symfony-applications/">Drop all Service Tags in Your Nette and Symfony Applications</a></em> first.
<br>
<br>
I'm very happy to see that <a href="/clusters/#collector-pattern-the-shortcut-hack-to-solid-code">collectors</a> are finally getting to the core of DI components of PHP frameworks. Tags, extensions, compiler passes and <code>autoconfigure</code> now became workarounds. Collectors are now in the best place they can... <strong>the PHP code</strong>.
                    </div>
                </div>

                
                <p>Let's say we need to build a tool for releasing a new version of the open-source package. Something like what I use for
<a href="https://github.com/symplify/monorepobuilder">Symplify and Rector releases</a>, <strong>but better</strong>.</p>
<p>You want it to be <em>open for extension and closed for modification</em>. How do we do that?</p>
<p>You introduce and a <code>ReleaseWorkerInterface</code>:</p>
<pre><code class="language-php">&lt;?php declare(strict_types=1);

namespace Moses\ReleaseWorker;

interface ReleaseWorkerInterface
{
    public function work(string $version): void;
}</code></pre>
<p>Good, now if anyone wants to extend it, they' just create a new service:</p>
<pre><code class="language-php">&lt;?php declare(strict_types=1);

namespace Moses\ReleaseWorker;

use Nette\Utils\Strings;

final class CheckBlogHasReleasePostReleaseWorker implements ReleaseWorkerInterface
{
    public function work(string $version): void
    {
        $blogContent = file_get_contents('https://tomasvotruba.cz');

        // is there a post with this title?
        if (Strings::match($blogContent, '#Release of ' . $version . '#')) {
            // good
            echo 'Good job! The blog post was released.';
            // early return
            return;
        }

        // bad
        throw new DoThisFirstException(sprintf('Write release post about "%s" version first', $version));
    }
}</code></pre>
<p>and register it</p>
<pre><code class="language-yaml"># moses.yml
services:
    Moses\ReleaseWorker\CheckBlogHasReleasePostReleaseWorker: ~</code></pre>
<h2 id="find-all-the-code-releaseworkerinterface-code"><a href="#find-all-the-code-releaseworkerinterface-code">Find all the <code>ReleaseWorkerInterface</code>?</a></h2>
<p>Note: I'll be mixing Nette | Symfony syntax now, but they're almost identical in DI component, so just imagine it's your favorite framework.</p>
<p>How can we get all the services that implement <code>ReleaseWorkerInterface</code>?</p>
<h3 id="1-tags"><a href="#1-tags">1. Tags!</a></h3>
<pre><code class="language-yaml">services:
    Moses\ReleaseWorker\CheckBlogHasReleasePostReleaseWorker:
        tags:
            - "release_worker"</code></pre>
<p>In extension/compiler pass:</p>
<pre><code class="language-php">&lt;?php declare(strict_types=1);

foreach ($containerBuilder-&gt;findByTags('release_worker') as $workerDefinition) {
   $mosesDefinition-&gt;addCall('addWorker', [$workerDefinition-&gt;getName()]);
}</code></pre>
<p>This is what we would do in 2010. <strong>This brings <a href="/blog/2018/08/27/why-and-how-to-avoid-the-memory-lock/">memory-lock</a> on tag name and disables common sense</strong>. And we need common sense to create usable code.</p>
<p>What's the next option we have?</p>
<h3 id="2-code-bytype-code-methods"><a href="#2-code-bytype-code-methods">2. <code>byType()</code> methods</a></h3>
<p>In extension/compiler pass:</p>
<pre><code class="language-php">&lt;?php declare(strict_types=1);

foreach ($containerBuilder-&gt;findByType(ReleaseWorkerInterface::class) as $workerDefinition) {
   $mosesDefinition-&gt;addCall('addWorker', [$workerDefinition-&gt;getName()]);
}</code></pre>
<p>This drops memory-lock, good. But <strong>we still have to go to extension/compiler-pass</strong>, lands that are visited by fractions of framework-users.</p>
<p>What about something &quot;2018&quot;?</p>
<h3 id="3-autowired-arrays"><a href="#3-autowired-arrays">3. Autowired Arrays</a></h3>
<p>All options above hides a contract. Which one? The <code>Moses</code> class looks like this:</p>
<pre><code class="language-php">&lt;?php declare(strict_types=1);

final class Moses
{
    // property + setter

    public function release(string $version)
    {
        foreach ($this-&gt;releaseWorkers as $releaseWorker) {
            $releaseWorker-&gt;work($version);
        }
    }
}</code></pre>
<p>What is wrong with this contract? Have you noticed the constructor? Me neither, <strong>it's not there!</strong> It needs at least some release workers, it's useless without it, but we lie about this contract:</p>
<pre><code class="language-php">&lt;?php declare(strict_types=1);

$moses = new Moses\Moses;
$moses-&gt;release('v5.0.0');

// nothing
// ...
// WTF?</code></pre>
<p>We already know that <strong>public properties, setters, and drugs are bad</strong>. <strong>Missing constructor contract and sniffing dependency somewhere else by setters - not good either</strong>. Moreover when your other classes keep that contract. What's the point of rules in your code then?</p>
<h3 id="success-is-given-to-reliable-people"><a href="#success-is-given-to-reliable-people">Success is Given to Reliable People</a></h3>
<p>We should make a design that is reliable.</p>
<ul>
<li>Do you need these services? Tell us in the constructor.</li>
<li>Do you need this parameter to work? <a href="/blog/2018/11/05/do-you-autowire-services-in-symfony-you-can-autowire-parameters-too/">Tell us constructor</a>.</li>
<li>Do you need all <code>ReleaseWorkerInterface</code>s? <strong>Tell us in the constructor.</strong></li>
</ul>
<pre><code class="language-php">&lt;?php declare(strict_types=1);

$releaseWorkers = [
    new Moses\ReleaseWorker\CheckBlogHasReleasePostReleaseWorker,
];

$moses = new Moses\Moses($releaseWorkers);</code></pre>
<p>Now when we call the service, <strong>we can actually see some output</strong>:</p>
<pre><code class="language-php">&lt;?php declare(strict_types=1);

$moses-&gt;release('v5.0.0');

// "Good job! The blog post was released."
// ...
// Thanks!</code></pre>
<p>Sound nice, right? Is that even possible? Without that, we could drop tags, the compiler passes, YAML/Neon stringly-typed configuration, anti-conception... The world would finally make sense again!</p>
<blockquote class="blockquote text-center">
    "Vision over Expectations."
</blockquote>
<p>It sounds really nice. But how would that work in PHP? How does container now what we need in the constructor. Yes, Mr. Potter?</p>
<pre><code class="language-php">&lt;?php declare(strict_types=1);

namespace Moses;

use Moses\ReleaseWorker\ReleaseWorkerInterface;

final class Moses
{
    /**
     * @param ReleaseWorkerInterface[] $releaseWorkers
     */
    public function __construct(array $releaseWorkers)
    {
    }
}</code></pre>
<p>No need for magic. <strong>Just use typehint in annotation</strong>.</p>
<p><br></p>
<p>Typehint in the annotation. It's that simple.</p>
<h2 id="when-can-i-use-that-my-favorite-framework"><a href="#when-can-i-use-that-my-favorite-framework">When Can I use That <my-favorite-framework>?</a></h2>
<p>I have no idea.</p>
<p>But you can <strong>install it today</strong>:</p>
<ul>
<li>with <code>"nette/di": "v3.0.0-beta1"</code> with <a href="https://github.com/nette/di/pull/178">this feature enabled in the core</a></li>
<li>and <code>"symplify/package-builder": "^5.2"</code> and <a href="https://github.com/Symplify/PackageBuilder#autowire-array-parameters"><code>AutowireArrayParameterCompilerPass</code></a></li>
</ul>
<h2 id="does-it-work"><a href="#does-it-work">Does it Work?</a></h2>
<p>Yes, for the cases above it's 1:1 substitution with 0-configuration. It's part of <a href="https://github.com/Symplify/Symplify/pull/1145/files">Symplify since 5.1</a> (released 1,5 month ago) and <strong>it works flawlessly</strong>.</p>
<p><br></p>
<p>And why <em>Moses</em>? Well, he <em>released</em> the most of people from slavery :)</p>

                <br>

                
                <div class="card mb-5">
                    <div class="card-body text-center">
                        <a href="https://github.com/TomasVotruba/tomasvotruba.cz/edit/master/source/_posts/2018/2018-11-12-will-autowired-arrays-finally-deprecate-tags-in-symfony-and-nette.md" class="btn btn-info btn-sm">
                            <em class="fas fa-fw fa-edit"></em>
                            Typo? Fix it, please
                        </a>
                        &nbsp;and join <a href="/thank-you">56 people</a> who build this website
                    </div>
                </div>

                <a name="comments"></a>

                <div id="disqus_thread"></div>

<script type="text/javascript">
    /**
     *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
     *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
     */
    (function() {  // DON'T EDIT BELOW THIS LINE
        var d = document, s = d.createElement('script');

        s.src = '//' + 'itsworthsharing' + '.disqus.com/embed.js';

        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
            </div>

            <script id="dsq-count-scr" src="https://itsworthsharing.disqus.com/count.js" async defer></script>
        </div>

        <script>
    ga=function(){ ga.q.push(arguments) };
    ga.q=[];
    ga.l=+new Date;
    ga('create', 'UA-46082345-1', 'auto');
    ga('send','pageview');
</script>
<script src="https://www.google-analytics.com/analytics.js" async defer></script>

<script src="/assets/prism/prism.js"></script>

<script>
    $('.gifplayer').gifplayer();
</script>

<div class="text-center mt-5" id="footer">
    <div class="row">
        <div class="col-12">
            Join 17 000 PHP developers every month: <a href="/rss.xml">RSS</a>&nbsp;or&nbsp;<a href="https://twitter.com/votrubaT">@votrubaT</a>

            <span class="pl-2 pr-2 hidden-sm-down">•</span>

            <span class="hidden-sm-down">
                Watch my <a href="https://github.com/tomasvotruba">open-source addiction</a>
            </span>
        </div>
    </div>

    <p>
        Build by <a href="/thank-you/">56 people</a>

        <span class="pl-2 pr-2">•</span>

        Runs on <a href="https://www.statie.org/">Statie</a>

        <span class="pl-2 pr-2">•</span>

        <a href="/now/">Now</a>

        <span class="hidden-sm-down">
            <span class="pl-2 pr-2">•</span>
            Hosted on <a href="https://github.com/tomasvotruba/tomasvotruba.cz">GitHub</a>
        </span>
    </p>
</div>
    </body>
</html>

        <meta property="og:type" content="article" />
    <meta property="og:title" content="Will Autowired Arrays Finally Deprecate Tags in Symfony and Nette?" />
    <meta property="og:description" content="To be clear: we talk about those tags that only have a name. No priority, no level, no event name, nothing, just the name. If you&#039;re not sure why these tags are bad, read Drop all Service Tags in Your Nette and Symfony Applications first.


I&#039;m very happy to see that collectors are finally getting to the core of DI components of PHP frameworks. Tags, extensions, compiler passes and autoconfigure now became workarounds. Collectors are now in the best place they can... the PHP code." />
    <meta property="og:url" content="https://www.tomasvotruba.cz/blog/2018/11/12/will-autowired-arrays-finally-deprecate-tags-in-symfony-and-nette" />

        <meta name="twitter:card" content="summary" />
    <meta name="twitter:site" content="@votrubaT">
    <meta name="twitter:title" content="Will Autowired Arrays Finally Deprecate Tags in Symfony and Nette?" />
    <meta name="twitter:description" content="To be clear: we talk about those tags that only have a name. No priority, no level, no event name, nothing, just the name. If you&#039;re not sure why these tags are bad, read Drop all Service Tags in Your Nette and Symfony Applications first.


I&#039;m very happy to see that collectors are finally getting to the core of DI components of PHP frameworks. Tags, extensions, compiler passes and autoconfigure now became workarounds. Collectors are now in the best place they can... the PHP code." />
