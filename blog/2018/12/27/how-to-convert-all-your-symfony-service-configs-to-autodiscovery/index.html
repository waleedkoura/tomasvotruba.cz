<!DOCTYPE html>
<html lang="en">
    <head>
    <title>How To Convert All Your Symfony Service Configs to Autodiscovery | Tomas Votruba</title>
    <meta charset="utf-8">
    <meta name="robots" content="index, follow">

        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">

    
    <link rel="alternate" type="application/rss+xml" title="Tomas Votruba Blog RSS" href="/rss.xml">

        <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.2.0/css/solid.css" integrity="sha384-wnAC7ln+XN0UKdcPvJvtqIH3jOjs9pnKnq9qX68ImXvOGz2JuFoEiCjT8jyZQX2z" crossorigin="anonymous">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.2.0/css/brands.css" integrity="sha384-nT8r1Kzllf71iZl81CdFzObMsaLOhqBU1JD2+XoAALbdtWaXDOlWOZTR4v1ktjPE" crossorigin="anonymous">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.2.0/css/fontawesome.css" integrity="sha384-HbmWTHay9psM8qyzEKPc8odH4DsOuzdejtnr+OFtDmOcIVnhgReQ4GZBH7uwcjf6" crossorigin="anonymous">

        <link href="/assets/bootstrap/bootstrap.min.css?v=1690818128" rel="stylesheet" type="text/css" />

    <link href="/assets/prism/prism.css?v=1894235032" rel="stylesheet" type="text/css" />

        <link href="/assets/css/style.css?v=657526243" rel="stylesheet" type="text/css" />

    <link href="/assets/gifplayer/gifplayer.css" rel="stylesheet" type="text/css" />

        <link href="/assets/css/checklist.css?v=634496264" rel="stylesheet" type="text/css" />

    <script src="/assets/js/jquery-3.3.1.slim.min.js"></script>
    <script src="/assets/gifplayer/jquery.gifplayer.js"></script>
    <script src="/assets/js/checklist.js" async defer></script>
</head>
    <body>
        <!-- post_id: 171 -->

        <div class="hidden-sm-down">
    <nav class="navbar">
        <div class="container-fluid">
            <ul>
                <li id="logo">
                    <img src="https://avatars1.githubusercontent.com/u/924196?s=60&v=4" class="avatar">
                    Tomas Votruba
                </li>
                <li class="active">
                    <a href="/">Blog</a>
                </li>
                <li class="">
                    <a href="/clusters/">Clusters</a>
                </li>
                <li class="">
                    <a href="/mission/">Mission</a>
                </li>
                <li class="">
                    <a href="/talks/">Talks</a>
                </li>
                <li class="">
                    <a href="/contact/">Contact</a>
                </li>
                <li id="top-menu-search">
                    <form method="get" action="https://www.google.com/search" itemprop="potentialAction" itemscope="" itemtype="http://schema.org/SearchAction">
                        <meta itemprop="target" content="https://www.google.com/search?q={q}"/>
                        <input name="sitesearch" value="tomasvotruba.cz" type="hidden"/>
                        <input itemprop="query-input" type="text" id="search-query" class="form-control" required="required" name="q" placeholder="Search..." autocomplete="off"/>
                    </form>
                </li>
            </ul>
        </div>
    </nav>
</div>

<div class="hidden-md-up">
    <nav class="navbar" id="mobile-menu">
        <div class="container">
            <a href="/" class="col-3 col-sm-3 active">
                <em class="fas fa-book"></em>
                <br>
                PHP Blog
            </a>
            <a href="/clusters/" class="col-3 col-sm-3 ">
                <em class="fas fa-share-alt"></em>
                <br>
                Clusters
            </a>
            <a href="/mission/" class="col-3 col-sm-3 ">
                <em class="fas fa-heartbeat"></em>
                <br>
                Mission
            </a>
            <a href="/contact/" class="col-3 col-sm-3 ">
                <em class="fas fa-phone"></em>
                <br>
                Contact
            </a>
        </div>
    </nav>

    <div class="hidden-md-up text-center row" id="top-menu-search-mobile">
        <!-- inspired and taken from: https://github.com/yegor256/blog/blob/master/_layouts/default.html -->
        <form method="get" action="https://www.google.com/search" itemprop="potentialAction" itemscope="" itemtype="http://schema.org/SearchAction" class="col-md-12">
            <meta itemprop="target" content="https://www.google.com/search?q={q}"/>
            <input name="sitesearch" value="tomasvotruba.cz" type="hidden"/>
            <input itemprop="query-input" type="text" id="search-query" class="form-control" required="required" name="q" placeholder="Search with Google..." autocomplete="off"/>
        </form>
    </div>
</div>

        <div class="mainContent">
            <div class="container-fluid" id="post">
                <h1 id="how-to-convert-all-your-symfony-service-configs-to-autodiscovery"><a href="#how-to-convert-all-your-symfony-service-configs-to-autodiscovery">How To Convert All Your Symfony Service Configs to Autodiscovery</a></h1>

                <ul class="list-inline post-metadata">
    <li class="list-inline-item mr-3">
        <em class="fas fa-clock fa-fw"></em>
        <strong>3 min</strong>
    </li>

    <li class="list-inline-item mr-3">
        <em class="fas fa-calendar fa-fw"></em>
        <time datetime="2018-12-Thu">Thu, Dec 27, 2018</time>
    </li>

            <li class="list-inline-item mr-3">
            <em class="fas fa-fw fa-comments"></em>
            <a href="https://www.tomasvotruba.cz/blog/2018/12/27/how-to-convert-all-your-symfony-service-configs-to-autodiscovery/#disqus_thread">X</a> comments
        </li>
    
            <li class="list-inline-item">
            <em class="fas fa-fw fa-edit"></em>
            <a href="https://github.com/TomasVotruba/tomasvotruba.cz/edit/master/source/_posts/2018/2018-12-27-how-to-convert-all-your-symfony-service-configs-to-autodiscovery.md">Typo? Fix me, please</a>
        </li>
    
    </ul>

                
                
                <div class="card card-bigger">
                    <div class="card-body">
                        Do you use Symfony autodiscovery services registration everywhere and your configs have no extra lines?
Skip this post and rather read another one.
<br>
<br>
But if <strong>you have many configs with manual service registration</strong>, tagging, and autowiring, keep reading. I'll show you how you can convert them easily be new Symplify package.
                    </div>
                </div>

                
                <h2 id="tl-dr"><a href="#tl-dr">tl;dr;</a></h2>
<img src="/assets/images/posts/2018/autodiscovery/demo.gif" class="img-thumbnail">
<p><br></p>
<p>I've been consulting a few Symfony e-commerce projects recently that all have <code>service.yml</code>. Big configs with manual service registration:</p>
<pre><code class="language-yaml">services:
    App\SomeService:
        autowire: true

    App\Controller\SomeController:
        autowire: true

    # 50 more lines...
    # 20 more files similar to this one</code></pre>
<p>I already wrote <a href="/blog/2017/05/07/how-to-refactor-to-new-dependency-injection-features-in-symfony-3-3/">How to refactor to new Dependency Injection features in Symfony 3.3</a>, so you can read it. But you don't have to, since <strong>this conversion can be automated</strong>...</p>
<pre><code class="language-yaml">services:
    _defaults:
        autowire: true
    App\:
        resource: /src</code></pre>
<p>...with <a href="https://github.com/Symplify/Autodiscovery">Symplify\Autodiscovery</a>.</p>
<h2 id="3-steps-to-your-minimalistic-configs"><a href="#3-steps-to-your-minimalistic-configs">3 Steps to Your Minimalistic Configs</a></h2>
<ol>
<li>
<p>Install the package</p>
<pre><code class="language-bash">composer require symplify/autodiscovery</code></pre>
</li>
<li>
<p>Convert Configs</p>
<p>Run on <code>/src</code> directory:</p>
<pre><code class="language-diff">vendor/bin/autodiscovery convert-yaml /src</code></pre>
<p>It converts all <code>services.yml</code>, <code>config.yml</code>, <code>config.dev.yml</code> etc. configs that contain <code>services:</code> to autodiscovery format.</p>
<p><code>*.yaml</code> included.</p>
</li>
<li>
<p>See the changes:</p>
<pre><code class="language-bash">git diff</code></pre>
</li>
</ol>
<h2 id="what-can-go-wrong"><a href="#what-can-go-wrong">What Can Go Wrong?</a></h2>
<p>There are many reasons to <strong>automate this work</strong>, because <strong>there are many gotchas</strong> you have to be careful about. In each single service registration.</p>
<h3 id="1-tags"><a href="#1-tags">1. Tags</a></h3>
<p>Name-only system tags <strong>can be removed</strong> thanks to <code>autoconfigure</code>:</p>
<pre><code class="language-diff"> services:
-    first_command:
-        class: App\Command\FirstCommand
-        tags:
-            - { name: 'console.command' }
-
-    second_command:
-        class: App\Command\SecondCommand
-        tags: ['console.command']
+    _defaults:
+        autoconfigure: true
+
+     App\Command\:
+         resource: '../src/Command'</code></pre>
<p>But you have to <strong>keep</strong> <a href="https://symfony.com/doc/current/console/commands_as_services.html#lazy-loading">lazy-loaded commands</a></p>
<pre><code class="language-yaml">services:
    first_command:
        class: App\Command\FirstCommand
        tags:
          - { name: 'console.command', command: 'first' }</code></pre>
<p>And tags with metadata:</p>
<pre><code class="language-yaml">services:
    App\EventListener\ExceptionListener:
        tags:
            - { name: 'kernel.event_listener', event: 'kernel.exception' }</code></pre>
<h3 id="2-single-class-names"><a href="#2-single-class-names">2. Single-class Names</a></h3>
<p>Service name can be often dropped:</p>
<pre><code class="language-diff"> services:
-    app.controller:
-        class: App\SomeController
+    App\SomeController: ~</code></pre>
<p>Except for classes with no namespace:</p>
<pre><code class="language-yaml">services:
    Single_Class_Name:
        class: Single_Class_Name</code></pre>
<h3 id="3-vendor-autodiscovery"><a href="#3-vendor-autodiscovery">3. Vendor Autodiscovery</a></h3>
<p>Configs are usually mixed of your code (<code>/app</code> or <code>/src</code>) and 3rd party code (<code>/vendor</code>):</p>
<pre><code class="language-yaml"># old config
services:
    App\SomeService: ~
    App\AnotherService: ~

    Symplify\PackageBuilder\Parameter\ParameterProvider: ~
    Symplify\PackageBuilder\FileSystem\FileGuard: ~</code></pre>
<p>Seeing this you have to think about that. If not, you might accidentally apply autodiscovery everywhere:</p>
<pre><code class="language-diff"> services:
-    App\SomeService: ~
-    App\AnotherService: ~
+    App\:
+        resource: ../src

-    Symplify\PackageBuilder\Parameter\ParameterProvider: ~
-    Symplify\PackageBuilder\FileSystem\FileGuard: ~
+    Symplify\PackageBuilder\: ~
+        resource: ../vendor/symplify/package-builder/src</code></pre>
<p>Ops, the last case should not be converted - <strong>all 3rd party classes have to be explicit</strong> since they're handled by their own config/bundle in <code>/vendor</code>:</p>
<pre><code class="language-yaml">services:
    Symplify\PackageBuilder\Parameter\ParameterProvider: ~
    Symplify\PackageBuilder\FileSystem\FileGuard: ~</code></pre>
<h3 id="4-exclude-obviously"><a href="#4-exclude-obviously">4. Exclude Obviously</a></h3>
<p>When you try to autoload a class with a constructor, it's considered a service. But not all classes with constructors are services. Symfony doesn't know that unless you tell it, and it would fail with missing argument exception.</p>
<pre><code class="language-diff"> services:
     App\:
        resource: ../src
+       exclude: ../src/{Entity,Exception,Contract}</code></pre>
<p>The converter includes support for basic dirs to be excluded.</p>
<p><br></p>
<p><strong>Do you want minimalist configs for your application?</strong> <a href="#3-steps-to-your-minimalistic-configs">Give Autodiscovery a try</a>.</p>

                <br>

                
                <div class="card mb-5">
                    <div class="card-body text-center">
                        <a href="https://github.com/TomasVotruba/tomasvotruba.cz/edit/master/source/_posts/2018/2018-12-27-how-to-convert-all-your-symfony-service-configs-to-autodiscovery.md" class="btn btn-info btn-sm">
                            <em class="fas fa-fw fa-edit"></em>
                            Typo? Fix it, please
                        </a>
                        &nbsp;and join <a href="/thank-you">56 people</a> who build this website
                    </div>
                </div>

                <a name="comments"></a>

                <div id="disqus_thread"></div>

<script type="text/javascript">
    /**
     *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
     *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
     */
    (function() {  // DON'T EDIT BELOW THIS LINE
        var d = document, s = d.createElement('script');

        s.src = '//' + 'itsworthsharing' + '.disqus.com/embed.js';

        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
            </div>

            <script id="dsq-count-scr" src="https://itsworthsharing.disqus.com/count.js" async defer></script>
        </div>

        <script>
    ga=function(){ ga.q.push(arguments) };
    ga.q=[];
    ga.l=+new Date;
    ga('create', 'UA-46082345-1', 'auto');
    ga('send','pageview');
</script>
<script src="https://www.google-analytics.com/analytics.js" async defer></script>

<script src="/assets/prism/prism.js"></script>

<script>
    $('.gifplayer').gifplayer();
</script>

<div class="text-center mt-5" id="footer">
    <div class="row">
        <div class="col-12">
            Join 17 000 PHP developers every month: <a href="/rss.xml">RSS</a>&nbsp;or&nbsp;<a href="https://twitter.com/votrubaT">@votrubaT</a>

            <span class="pl-2 pr-2 hidden-sm-down">•</span>

            <span class="hidden-sm-down">
                Watch my <a href="https://github.com/tomasvotruba">open-source addiction</a>
            </span>
        </div>
    </div>

    <p>
        Build by <a href="/thank-you/">56 people</a>

        <span class="pl-2 pr-2">•</span>

        Runs on <a href="https://www.statie.org/">Statie</a>

        <span class="pl-2 pr-2">•</span>

        <a href="/now/">Now</a>

        <span class="hidden-sm-down">
            <span class="pl-2 pr-2">•</span>
            Hosted on <a href="https://github.com/tomasvotruba/tomasvotruba.cz">GitHub</a>
        </span>
    </p>
</div>
    </body>
</html>

        <meta property="og:type" content="article" />
    <meta property="og:title" content="How To Convert All Your Symfony Service Configs to Autodiscovery" />
    <meta property="og:description" content="Do you use Symfony autodiscovery services registration everywhere and your configs have no extra lines?
Skip this post and rather read another one.


But if you have many configs with manual service registration, tagging, and autowiring, keep reading. I&#039;ll show you how you can convert them easily be new Symplify package." />
    <meta property="og:url" content="https://www.tomasvotruba.cz/blog/2018/12/27/how-to-convert-all-your-symfony-service-configs-to-autodiscovery" />

        <meta name="twitter:card" content="summary" />
    <meta name="twitter:site" content="@votrubaT">
    <meta name="twitter:title" content="How To Convert All Your Symfony Service Configs to Autodiscovery" />
    <meta name="twitter:description" content="Do you use Symfony autodiscovery services registration everywhere and your configs have no extra lines?
Skip this post and rather read another one.


But if you have many configs with manual service registration, tagging, and autowiring, keep reading. I&#039;ll show you how you can convert them easily be new Symplify package." />
